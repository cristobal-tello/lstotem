substitutions:
  _REGION: europe-southwest1

options:
  logging: CLOUD_LOGGING_ONLY

steps:
  - name: "gcr.io/cloud-builders/docker"
    dir: web
    id: BuildWebAppImage
    args:
      - "build"
      - "-f" 
      - "Dockerfile.prod" 
      - "-t"
      - "${_RUN_REGION}-docker.pkg.dev/$PROJECT_ID/${_SERVICE_NAME}/${_SERVICE_NAME}:latest"
      - "."

  - name: "gcr.io/cloud-builders/docker"
    id: PushWebAppImage
    args:
      - "push"
      - "${_RUN_REGION}-docker.pkg.dev/$PROJECT_ID/${_SERVICE_NAME}/${_SERVICE_NAME}:latest"

  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    id: DeployWebAppToCloudRun
    entrypoint: gcloud
    args:
      - "run"
      - "deploy"
      - "${_SERVICE_NAME}"
      - "--image=${_RUN_REGION}-docker.pkg.dev/$PROJECT_ID/${_SERVICE_NAME}/${_SERVICE_NAME}:latest"
      - "--region=${_RUN_REGION}"
      - "--platform=managed"
      - "--allow-unauthenticated"
      - "--port=80"
      - "--memory=256Mi"

  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    id: DeployStoreOrderData
    entrypoint: gcloud
    args:
      - functions
      - deploy
      - store-order-data
      - --gen2
      - --region=${_REGION}
      - --runtime=python312
      - --source=functions/store_order_data
      - --entry-point=store_order_data
      - --trigger-topic=prestashop-order-data
      - --memory=256Mi
      - --timeout=180s

  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    id: DeployNotifierOrderMilestone
    entrypoint: gcloud
    args:
    - functions
    - deploy
    - notifier-order-milestone
    - --gen2
    - --region=${_REGION}
    - --runtime=python312
    - --source=functions/notifier_order_milestone
    - --entry-point=notifier_order_milestone
    - --trigger-event-filters=type=google.cloud.firestore.document.v1.written
    - --trigger-event-filters=database=(default)
    - --trigger-event-filters-path-pattern=document=orders/{order_id} 
    - --memory=256Mi
    - --timeout=180s
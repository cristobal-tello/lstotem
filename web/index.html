<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pusher Notification Receiver (Public)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://js.pusher.com/8.0.1/pusher.min.js"></script>

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f3f4f6;
    }
    .container-card {
      box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1),
                  0 0 15px -5px rgba(0,0,0,0.04);
      transition: transform 0.3s ease-in-out;
    }
    .message-item {
      animation: fadeIn 0.5s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="p-4 sm:p-8 min-h-screen flex items-start justify-center">
  <div class="w-full max-w-2xl bg-white rounded-xl container-card p-6 sm:p-8 mt-10">
    <h1 class="text-3xl font-bold text-gray-800 mb-2">
      Super Real-Time Notification Listener
    </h1>
    <p class="text-sm text-gray-500 mb-6">
      Listening on Channel:
      <code class="font-mono text-indigo-600">lstotem-public</code> |
      Event:
      <code class="font-mono text-indigo-600">total-orders</code>
    </p>

    <div id="status-display"
         class="p-3 mb-6 rounded-lg text-sm font-medium transition-all bg-yellow-100 text-yellow-800">
      Connecting...
    </div>

    <h2 class="text-xl font-semibold text-gray-700 mb-3 border-b pb-2">
      Received Notifications
    </h2>
    <ul id="notifications-list" class="space-y-3">
      <li class="text-gray-500 italic">Waiting for the first real-time message...</li>
    </ul>
  </div>

  <script>
    // --- Configuration ---
    const PUSHER_APP_KEY = "82c4ec18f6b4eccb9daf"; 
    const PUSHER_CLUSTER = "eu";
    const CHANNEL_NAME = "Test140824"; 
    const EVENT_NAME = "total-orders";
    
    const notificationsList = document.getElementById("notifications-list");
    const statusDisplay = document.getElementById("status-display");
    
    let pusher = null;
    let channel = null;

    // Función para actualizar el estado de conexión
    function updateStatus(state, message) {
      statusDisplay.textContent = message;
      statusDisplay.className = "p-3 mb-6 rounded-lg text-sm font-medium transition-all";
      if (state === "connected") {
        statusDisplay.classList.add("bg-green-100", "text-green-800");
      } else if (state === "disconnected" || state === "unavailable" || state === "error") {
        statusDisplay.classList.add("bg-red-100", "text-red-800");
      } else {
        statusDisplay.classList.add("bg-yellow-100", "text-yellow-800");
      }
      console.log(`Pusher Status: ${state} - ${message}`);
    }

    // Función para mostrar la notificación en la lista
    function displayNotification(data) {
      if (notificationsList.querySelector("li.italic")) {
        notificationsList.innerHTML = "";
      }
      
      const messageText = data.message ? 
                          `New order data received: ${data.message}` : 
                          `Received event data: ${JSON.stringify(data)}`;

      const li = document.createElement("li");
      li.className = "p-4 bg-gray-50 rounded-lg border border-gray-200 message-item flex justify-between items-center";
      
      const content = document.createElement("p");
      content.className = "text-gray-700 text-sm";
      content.textContent = messageText;
      
      const time = document.createElement("span");
      time.className = "text-xs text-gray-400 ml-4 whitespace-nowrap";
      time.textContent = new Date().toLocaleTimeString();

      li.appendChild(content);
      li.appendChild(time);
      
      notificationsList.prepend(li);
    }

    // --- Inicialización y Conexión ---
    function initializePusher() {
      Pusher.logToConsole = true;

      // Crea la instancia de Pusher: SIN la configuración 'authEndpoint'
      pusher = new Pusher(PUSHER_APP_KEY, {
        cluster: PUSHER_CLUSTER,
        forceTLS: true
      });

      // Escucha los eventos de conexión de Pusher
      pusher.connection.bind('state_change', (states) => {
        updateStatus(states.current, `Pusher is now ${states.current}.`);
      });

      // Suscribe al canal público
      channel = pusher.subscribe(CHANNEL_NAME);
      
      // Los canales públicos no necesitan 'pusher:subscription_succeeded' o manejo de errores de autenticación.
      
      // Escucha el evento específico
      channel.bind(EVENT_NAME, (data) => {
        displayNotification(data);
      });
    }

    // Inicia la conexión cuando la página esté lista
    document.addEventListener('DOMContentLoaded', initializePusher);
  </script>
</body>
</html>